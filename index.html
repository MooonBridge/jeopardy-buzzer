<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Jeopardy Buzzer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mqtt/4.3.7/mqtt.min.js"></script>
    <style>
        body { background-color: #121212; color: white; font-family: 'Segoe UI', sans-serif; text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; overflow: hidden; }

        .setup-screen { display: flex; flex-direction: column; gap: 15px; }
        input, select, button { padding: 15px; font-size: 1.2rem; border-radius: 8px; border: none; width: 80vw; max-width: 300px; }
        button { background: #283593; color: white; font-weight: bold; cursor: pointer; }

        #buzzer-btn {
            width: 80vw; height: 80vw; max-width: 300px; max-height: 300px;
            border-radius: 50%; border: 5px solid #333;
            font-size: 2rem; font-weight: bold; color: #555;
            background: #222;
            box-shadow: inset 0 0 20px #000;
            transition: all 0.2s;
            pointer-events: none; /* Disabled by default */
        }

        /* Status Klassen */
        .unlocked {
            background: radial-gradient(circle, #00e676, #00c853) !important;
            color: white !important;
            border-color: #00c853 !important;
            box-shadow: 0 0 30px #00e676 !important;
            pointer-events: auto !important;
            cursor: pointer;
        }
        .buzzed {
            background: radial-gradient(circle, #ffea00, #ffd600) !important;
            color: black !important;
            border-color: #ffd600 !important;
            transform: scale(0.95);
        }
        .locked {
            background: #222 !important;
            color: #555 !important;
            border-color: #333 !important;
        }

        #status { margin-top: 20px; font-size: 1.2rem; color: #888; }
    </style>
</head>
<body>

    <div id="setup" class="setup-screen">
        <h1>Jeopardy Buzzer</h1>
        <input type="text" id="roomCode" placeholder="Raum Code (z.B. JEO-1234)" style="text-transform: uppercase;">
        <select id="playerIdx">
            <option value="1">Spieler 1</option>
            <option value="2">Spieler 2</option>
            <option value="3">Spieler 3</option>
            <option value="4">Spieler 4</option>
            <option value="5">Spieler 5</option>
            <option value="6">Spieler 6</option>
        </select>
        <button onclick="connect()">Verbinden</button>
    </div>

    <div id="game" style="display: none;">
        <button id="buzzer-btn" onclick="buzz()">GESPERRT</button>
        <div id="status">Warte auf Freigabe...</div>
    </div>

    <script>
        const BROKER = "wss://broker.hivemq.com:8000/mqtt";
        let client;
        let roomId;
        let playerNum;

        function connect() {
            roomId = document.getElementById("roomCode").value.trim().toUpperCase();
            playerNum = document.getElementById("playerIdx").value;

            if (!roomId) return alert("Bitte Raum Code eingeben!");

            document.getElementById("setup").style.display = "none";
            document.getElementById("game").style.display = "flex";

            client = mqtt.connect(BROKER);

            client.on("connect", () => {
                document.getElementById("status").innerText = "Verbunden mit " + roomId;
                // Subscribe Status
                client.subscribe(`jeopardy/${roomId}/status`);
            });

            client.on("message", (topic, message) => {
                const msg = message.toString();
                const btn = document.getElementById("buzzer-btn");

                if (msg === "unlocked") {
                    btn.className = "unlocked";
                    btn.innerText = "BUZZER!";
                    document.getElementById("status").innerText = "JETZT DRÃœCKEN!";
                    navigator.vibrate([50]);
                } else if (msg === "locked") {
                    btn.className = "locked";
                    btn.innerText = "GESPERRT";
                    document.getElementById("status").innerText = "Gesperrt";
                }
            });
        }

        function buzz() {
            const btn = document.getElementById("buzzer-btn");
            // Sende Buzz
            client.publish(`jeopardy/${roomId}/buzz`, playerNum);

            // Visuelles Feedback
            btn.className = "buzzed";
            btn.innerText = "GEBUZZERT!";
            navigator.vibrate([100]);

            // Nach Buzz sperren wir uns selbst kurz visuell, bis Host entscheidet
            // (Technisch wird Host eh "locked" senden wenn einer drangenommen wird)
        }
    </script>
</body>
</html>