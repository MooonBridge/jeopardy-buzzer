<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Jeopardy Buzzer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mqtt/4.3.7/mqtt.min.js"></script>
    <style>
        body { background-color: #121212; color: white; font-family: 'Segoe UI', sans-serif; text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; overflow: hidden; }
        
        .setup-screen { display: flex; flex-direction: column; gap: 15px; width: 90%; max-width: 400px;}
        input, button { padding: 15px; font-size: 1.2rem; border-radius: 8px; border: none; width: 100%; box-sizing: border-box; }
        input { background: #333; color: white; border: 1px solid #555; outline: none; }
        input:focus { border-color: #FFD700; }
        button { background: #283593; color: white; font-weight: bold; cursor: pointer; transition: background 0.2s; }
        button:active { transform: scale(0.98); }
        
        h1, h2 { margin-bottom: 10px; color: #FFD700; }

        .name-list { display: flex; flex-direction: column; gap: 10px; max-height: 60vh; overflow-y: auto; width: 100%; }
        .name-btn { background: #333; color: white; text-align: left; padding: 15px 20px; font-size: 1.1rem; border: 1px solid #444; cursor: pointer; }
        .name-btn:hover { background: #444; border-color: #FFD700; }
        
        #buzzer-btn {
            width: 70vw; height: 70vw; max-width: 300px; max-height: 300px;
            border-radius: 50%; border: 8px solid #333; 
            font-size: 2rem; font-weight: bold; color: #555;
            background: #222;
            box-shadow: inset 0 0 20px #000;
            transition: all 0.1s;
            pointer-events: none; 
            margin-top: 20px;
            display: flex; align-items: center; justify-content: center;
            user-select: none; -webkit-user-select: none;
        }

        .unlocked {
            background: radial-gradient(circle, #00e676, #00c853) !important;
            color: white !important;
            border-color: #00c853 !important;
            box-shadow: 0 0 40px rgba(0, 230, 118, 0.4) !important;
            pointer-events: auto !important;
            cursor: pointer;
        }
        .unlocked:active {
            transform: scale(0.95);
        }

        .buzzed {
            background: radial-gradient(circle, #ffea00, #ffd600) !important;
            color: black !important;
            border-color: #ffd600 !important;
            box-shadow: 0 0 40px rgba(255, 214, 0, 0.6) !important;
        }
        
        .locked {
            background: #222 !important;
            color: #555 !important;
            border-color: #333 !important;
        }
        
        #status { margin-top: 30px; font-size: 1.4rem; color: #888; font-weight: bold; }
        #room-display { position: absolute; top: 20px; left: 20px; font-size: 0.9rem; color: #666; }
        
        .hidden { display: none !important; }
        .flex { display: flex !important; }
    </style>
</head>
<body>

    <!-- 1. LOGIN SCREEN -->
    <div id="screen-room" class="setup-screen">
        <h1>Jeopardy Buzzer</h1>
        <p style="color:#aaa; font-size:0.9rem; margin:0;">Verbindung zum Spielserver</p>
        
        <input type="text" id="roomCode" placeholder="Raum Code (z.B. JEO-1234)" style="text-transform: uppercase; text-align:center; font-weight:bold; letter-spacing: 1px;">
        <input type="password" id="mqttPass" placeholder="Passwort" style="text-align:center;">
        
        <button onclick="connectAndFetchPlayers()">Beitreten</button>
        <div id="conn-status" style="color: #888; margin-top: 10px; font-size: 0.9rem;"></div>
    </div>

    <!-- 2. NAME SELECT -->
    <div id="screen-name" class="setup-screen hidden">
        <h2>Wer bist du?</h2>
        <div id="nameList" class="name-list">Lade Spieler...</div>
        <button onclick="location.reload()" style="background:#444; margin-top:20px;">Zurück</button>
    </div>

    <!-- 3. GAME -->
    <div id="screen-game" class="hidden" style="flex-direction: column; align-items: center; width: 100%;">
        <div id="room-display"></div>
        <h2 id="playerNameDisplay" style="font-size: 2rem; margin-top: 40px;">Spieler</h2>
        
        <div id="buzzer-container">
            <button id="buzzer-btn" onclick="buzz()">GESPERRT</button>
        </div>
        
        <div id="status">Warte auf Freigabe...</div>
    </div>

    <script>
        // HiveMQ Cloud WebSocket Adresse
        const BROKER = "wss://8a4b97051b294cff830f708512f57d7c.s1.eu.hivemq.cloud:8884/mqtt";
        const MQTT_USER = "jeopardy_user"; // Fest gesetzter User
        
        let client;
        let roomId;
        let playerNum;

        function connectAndFetchPlayers() {
            const inputRoom = document.getElementById("roomCode");
            const inputPass = document.getElementById("mqttPass");
            const statusDiv = document.getElementById("conn-status");
            
            roomId = inputRoom.value.trim().toUpperCase();
            const password = inputPass.value.trim();
            
            // Validierung
            if (!roomId) {
                inputRoom.style.borderColor = "red";
                inputRoom.focus();
                return;
            }
            if (!password) {
                inputPass.style.borderColor = "red";
                inputPass.focus();
                return;
            }

            statusDiv.innerText = "Verbinde zu Server...";
            inputRoom.style.borderColor = "#555";
            inputPass.style.borderColor = "#555";
            
            const clientId = "jeo_client_" + Math.random().toString(16).substr(2, 8);
            
            try {
                client = mqtt.connect(BROKER, { 
                    clientId: clientId,
                    username: MQTT_USER,
                    password: password, // Das eingegebene Passwort nutzen
                    connectTimeout: 5000 // 5s Timeout
                });
            } catch(e) {
                statusDiv.innerText = "Fehler beim Init: " + e.message;
                return;
            }
            
            client.on("connect", () => {
                statusDiv.innerText = "Verbunden! Suche Raum...";
                
                // Subscribe auf Antwort-Kanal
                client.subscribe(`jeopardy/${roomId}/players_response`);
                
                // Sende Anfrage
                client.publish(`jeopardy/${roomId}/players_request`, "get");
                
                // Timeout falls Raum nicht existiert (oder Python aus ist)
                setTimeout(() => {
                    if(document.getElementById("screen-room").classList.contains("hidden") === false) {
                        statusDiv.innerText = "Keine Antwort vom Host. Ist Python an & Code richtig?";
                    }
                }, 4000);
            });

            client.on("message", (topic, message) => {
                // 1. SPIELERLISTE EMPFANGEN -> Wechsel zu Screen 2
                if (topic.endsWith("players_response")) {
                    try {
                        const names = JSON.parse(message.toString());
                        showNameSelection(names);
                    } catch(e) {
                        console.error("JSON Error", e);
                    }
                }
                
                // 2. GAME STATUS (LOCKED/UNLOCKED)
                if (topic.endsWith("status")) {
                    const msg = message.toString();
                    updateBuzzerState(msg);
                }
            });
            
            client.on("error", (err) => {
                console.log(err);
                statusDiv.innerText = "Verbindungsfehler! Passwort falsch?";
                client.end();
            });
            
            client.on("offline", () => {
                statusDiv.innerText = "Verbindung verloren/falsch.";
            });
        }

        function showNameSelection(names) {
            document.getElementById("screen-room").classList.add("hidden");
            document.getElementById("screen-name").classList.remove("hidden");
            document.getElementById("screen-name").classList.add("flex");
            
            const list = document.getElementById("nameList");
            list.innerHTML = "";
            
            if(names.length === 0) {
                list.innerHTML = "<p style='color:#888'>Keine Spieler im Python-Host angelegt.</p>";
            }

            names.forEach((name, index) => {
                const btn = document.createElement("button");
                btn.className = "name-btn";
                btn.innerText = name;
                // 1-based index für Python Logik
                btn.onclick = () => joinGame(index + 1, name); 
                list.appendChild(btn);
            });
        }

        function joinGame(idx, name) {
            playerNum = idx;
            document.getElementById("screen-name").classList.add("hidden");
            document.getElementById("screen-name").classList.remove("flex");
            
            document.getElementById("screen-game").classList.remove("hidden");
            document.getElementById("screen-game").classList.add("flex");
            
            document.getElementById("playerNameDisplay").innerText = name;
            document.getElementById("room-display").innerText = "Room: " + roomId;
            
            // Subscribe Game Status Kanal
            client.subscribe(`jeopardy/${roomId}/status`);
            
            // Initial locked
            updateBuzzerState("locked");
        }
        
        function updateBuzzerState(state) {
            const btn = document.getElementById("buzzer-btn");
            const stat = document.getElementById("status");
            
            if (state === "unlocked") {
                btn.className = "unlocked";
                btn.innerText = "BUZZER!";
                stat.innerText = "JETZT DRÜCKEN!";
                stat.style.color = "#00e676";
                if(navigator.vibrate) navigator.vibrate(100); 
                
            } else if (state === "locked") {
                btn.className = "locked";
                btn.innerText = "GESPERRT";
                stat.innerText = "Warte auf Freigabe...";
                stat.style.color = "#888";
            }
        }

        function buzz() {
            const btn = document.getElementById("buzzer-btn");
            // Sende Buzz
            client.publish(`jeopardy/${roomId}/buzz`, playerNum.toString());
            
            // Visuelles Feedback sofort
            btn.className = "buzzed";
            btn.innerText = "GEBUZZERT!";
            document.getElementById("status").innerText = "Signal gesendet!";
            
            if(navigator.vibrate) navigator.vibrate([50, 50, 50]);
            
            // Lokaler Lock um Spam zu verhindern (Server sendet eh locked, aber für Latenz gut)
            setTimeout(() => {
               if (btn.innerText === "GEBUZZERT!") {
                   btn.className = "locked";
                   btn.innerText = "GESPERRT";
               }
            }, 1000);
        }
    </script>
</body>
</html>
