<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Jeopardy Buzzer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mqtt/4.3.7/mqtt.min.js"></script>
    <style>
        body { background-color: #121212; color: white; font-family: 'Segoe UI', sans-serif; text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; overflow: hidden; }
        .setup-screen { display: flex; flex-direction: column; gap: 15px; width: 90%; max-width: 400px;}
        input, button { padding: 15px; font-size: 1.2rem; border-radius: 8px; border: none; width: 100%; box-sizing: border-box; }
        input { background: #333; color: white; border: 1px solid #555; outline: none; }
        input:focus { border-color: #FFD700; }
        button { background: #283593; color: white; font-weight: bold; cursor: pointer; transition: background 0.2s; }
        button:active { transform: scale(0.98); }
        h1, h2 { margin-bottom: 10px; color: #FFD700; }
        .name-list { display: flex; flex-direction: column; gap: 10px; max-height: 60vh; overflow-y: auto; width: 100%; }
        .name-btn { background: #333; color: white; text-align: left; padding: 15px 20px; font-size: 1.1rem; border: 1px solid #444; cursor: pointer; }
        .name-btn:hover { background: #444; border-color: #FFD700; }

        #buzzer-btn {
            width: 70vw; height: 70vw; max-width: 300px; max-height: 300px;
            border-radius: 50%; border: 8px solid #222;
            font-size: 2rem; font-weight: bold; color: #888;
            background: #d32f2f;
            box-shadow: inset 0 0 20px #000;
            transition: all 0.1s;
            pointer-events: none;
            margin-top: 20px;
            display: flex; align-items: center; justify-content: center;
            user-select: none; -webkit-user-select: none;
        }

        .unlocked {
            background: radial-gradient(circle, #00e676, #00c853) !important;
            color: white !important;
            border-color: #00c853 !important;
            box-shadow: 0 0 40px rgba(0, 230, 118, 0.4) !important;
            pointer-events: auto !important;
            cursor: pointer;
        }
        .unlocked:active { transform: scale(0.95); }

        .buzzed {
            background: #555 !important;
            color: #aaa !important;
            border-color: #777 !important;
            box-shadow: none !important;
        }

        .locked {
            background: #d32f2f !important;
            color: #ffcccc !important;
            border-color: #b71c1c !important;
        }

        #status { margin-top: 30px; font-size: 1.4rem; color: #888; font-weight: bold; }
        #room-display { position: absolute; top: 20px; left: 20px; font-size: 0.9rem; color: #666; }
        .hidden { display: none !important; }
        .flex { display: flex !important; }
    </style>
</head>
<body>

    <div id="screen-room" class="setup-screen">
        <h1>Jeopardy Buzzer</h1>
        <input type="text" id="roomCode" placeholder="Raum Code" style="text-transform: uppercase; text-align:center;">
        <input type="password" id="mqttPass" placeholder="Passwort" style="text-align:center;">
        <button onclick="connectAndFetchPlayers()">Beitreten</button>
        <div id="conn-status" style="color: #888; margin-top: 10px; font-size: 0.9rem;"></div>
    </div>

    <div id="screen-name" class="setup-screen hidden">
        <div style="display: flex; align-items: center; margin-bottom: 10px;">
             <button onclick="location.reload()" style="width: 40px; height: 40px; padding: 0; background: #333; border-radius: 50%; font-size: 1.2rem;">◄</button>
             <h2 style="margin: 0 0 0 20px;">Wer bist du?</h2>
        </div>
        <div id="nameList" class="name-list"></div>
    </div>

    <div id="screen-game" class="hidden" style="flex-direction: column; align-items: center; width: 100%;">
        <div id="room-display"></div>
        <h2 id="playerNameDisplay" style="font-size: 2rem; margin-top: 40px;">Spieler</h2>
        <div id="buzzer-container">
            <button id="buzzer-btn" onclick="buzz()">GESPERRT</button>
        </div>
        <div id="status">Warte...</div>
        <button onclick="leaveGame()" style="background:#444; margin-top:40px; width:auto; padding: 10px 20px;">Abmelden</button>
    </div>

    <script>
        const BROKER = "wss://8a4b97051b294cff830f708512f57d7c.s1.eu.hivemq.cloud:8884/mqtt";
        const MQTT_USER = "jeopardy_user";
        let client, roomId, playerNum, isPlaying = false;
        let pingInterval = null;
        let currentRtt = 0; // Speichert die neueste gemessene RTT

        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space' && !document.getElementById("screen-game").classList.contains("hidden")) {
                e.preventDefault(); const b = document.getElementById("buzzer-btn");
                if (b.classList.contains("unlocked")) buzz();
            }
        });

        window.addEventListener('pagehide', () => { 
            if (isPlaying && client?.connected) client.publish(`jeopardy/${roomId}/leave`, playerNum.toString());
            if (pingInterval) clearInterval(pingInterval); 
        });

        function leaveGame() {
            if (confirm("Abmelden?")) {
                if (client?.connected) client.publish(`jeopardy/${roomId}/leave`, playerNum.toString());
                if (pingInterval) clearInterval(pingInterval);
                location.reload();
            }
        }

        function startPingLoop() {
            if (pingInterval) clearInterval(pingInterval);
            // Sendet jetzt jede 1 Sekunde (1000ms) einen Ping
            pingInterval = setInterval(sendPing, 1000); 
            // Sendet sofort einen initialen Ping
            sendPing();
        }
        
        function sendPing() {
            if (!client?.connected || !isPlaying) return;
            const payload = JSON.stringify({ 
                type: "ping", 
                playerIdx: playerNum - 1, 
                ts: Date.now(), // Client Timestamp für Offset-Korrektur
                client_send_ts: Date.now(), // Timestamp für RTT-Messung
                last_rtt: currentRtt // Sende die zuletzt gemessene RTT
            });
            client.publish(`jeopardy/${roomId}/ping`, payload);
        }

        function connectAndFetchPlayers() {
            roomId = document.getElementById("roomCode").value.trim().toUpperCase();
            const pass = document.getElementById("mqttPass").value.trim();
            if(!roomId || !pass) return;
            document.getElementById("conn-status").innerText = "Verbinde...";
            const clientId = "jeo_" + Math.random().toString(16).substr(2, 8);
            try { client = mqtt.connect(BROKER, { clientId, username: MQTT_USER, password: pass, connectTimeout: 5000 }); } catch(e) { return; }

            client.on("connect", () => {
                client.subscribe(`jeopardy/${roomId}/#`);
                client.publish(`jeopardy/${roomId}/players_request`, "get");
                document.getElementById("conn-status").innerText = "Verbunden. Lade Spieler...";
                setTimeout(() => {
                    if(!document.getElementById("screen-room").classList.contains("hidden") && document.getElementById("conn-status").innerText.includes("Lade Spieler"))
                        document.getElementById("conn-status").innerText = "Keine Spieler-Antwort vom Host.";
                }, 4000);
            });

            client.on("message", (topic, message) => {
                const msg = message.toString();
                if (topic.endsWith("players_response") && !isPlaying) {
                    try { const players = JSON.parse(msg); showNameSelection(players); } catch(e) {}
                }
                if (topic.endsWith("status_json") && isPlaying) updateBuzzerStateJSON(JSON.parse(msg));
                if (topic.endsWith("status") && msg === "game_over") { alert("Spiel beendet"); location.reload(); }
                
                // PONG HANDLING
                if (topic.endsWith("pong") && isPlaying) {
                    try {
                        const data = JSON.parse(msg);
                        // Überprüfe, ob es der PONG zu einem Ping war, der den client_send_ts gesendet hat
                        if (data.client_send_ts) {
                            // Berechne RTT (Round Trip Time: Sendezeit - Empfangszeit)
                            currentRtt = Date.now() - data.client_send_ts;
                        }
                    } catch(e) {}
                }
            });
            client.on("error", (e) => { document.getElementById("conn-status").innerText = "Verbindungsfehler!"; client.end(); });
        }

        function showNameSelection(players) {
            document.getElementById("screen-room").classList.add("hidden");
            document.getElementById("screen-name").classList.remove("hidden");
            document.getElementById("screen-name").classList.add("flex");
            const list = document.getElementById("nameList"); list.innerHTML = "";

            // Filter: Nur Spieler, die NICHT 'taken' sind
            const available = players.filter(p => !p.taken);

            if(available.length === 0) list.innerHTML = "<p style='color:#888'>Alle belegt.</p>";

            available.forEach((p) => {
                const btn = document.createElement("button");
                btn.className = "name-btn";
                btn.innerText = p.name;
                btn.onclick = () => joinGame(p.id, p.name);
                list.appendChild(btn);
            });
        }

        function joinGame(idx, name) {
            playerNum = idx; isPlaying = true;
            document.getElementById("screen-name").classList.add("hidden");
            document.getElementById("screen-name").classList.remove("flex");
            document.getElementById("screen-game").classList.remove("hidden");
            document.getElementById("screen-game").classList.add("flex");
            document.getElementById("playerNameDisplay").innerText = name;
            document.getElementById("room-display").innerText = "Room: " + roomId;
            client.publish(`jeopardy/${roomId}/join`, idx.toString());
            updateBuzzerStateJSON({state: "locked"});
            startPingLoop(); // Starte den Ping-Loop, sobald der Spieler beigetreten ist
        }

        function updateBuzzerStateJSON(data) {
            const btn = document.getElementById("buzzer-btn");
            const stat = document.getElementById("status");
            if (data.state === "unlocked") {
                if (data.excluded_list && data.excluded_list.includes(playerNum - 1)) {
                     btn.className = "locked";
                     btn.innerText = "GESPERRT";
                     stat.innerText = "Bereits geantwortet"; 
                     stat.style.color = "#FF5555"; 
                } else {
                    btn.className = "unlocked";
                    btn.innerText = "BUZZER!";
                    stat.innerText = "JETZT DRÜCKEN!";
                    stat.style.color = "#00e676";
                    if(navigator.vibrate) navigator.vibrate(100);
                }
            } else {
                btn.className = "locked";
                btn.innerText = "GESPERRT";
                stat.innerText = "Warte...";
                stat.style.color = "#888";
            }
        }

        function buzz() {
            const btn = document.getElementById("buzzer-btn");
            // Sende den Client-Timestamp mit, um die Latenz zu korrigieren
            client.publish(`jeopardy/${roomId}/buzz`, JSON.stringify({ type: "buzz", playerIdx: playerNum - 1, ts: Date.now() })); 
            btn.className = "buzzed";
            btn.innerText = "GEBUZZERT!";
            document.getElementById("status").innerText = "Signal gesendet!";
            if(navigator.vibrate) navigator.vibrate([50,50,50]);
            setTimeout(() => { if(btn.innerText==="GEBUZZERT!") { btn.className="locked"; btn.innerText="GESPERRT"; } }, 1000);
        }
    </script>
</body>
</html>
