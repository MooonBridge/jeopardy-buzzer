<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Jeopardy Buzzer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mqtt/4.3.7/mqtt.min.js"></script>
    <style>
        body { background-color: #121212; color: white; font-family: 'Segoe UI', sans-serif; text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; overflow: hidden; }
        .setup-screen { display: flex; flex-direction: column; gap: 15px; width: 90%; max-width: 400px;}
        input, button { padding: 15px; font-size: 1.2rem; border-radius: 8px; border: none; width: 100%; box-sizing: border-box; }
        input { background: #333; color: white; border: 1px solid #555; outline: none; }
        button { background: #283593; color: white; font-weight: bold; cursor: pointer; }
        .name-btn { background: #333; color: white; text-align: left; padding: 15px; font-size: 1.1rem; border: 1px solid #444; width: 100%; margin-bottom: 10px; }
        #buzzer-btn { width: 70vw; height: 70vw; max-width: 300px; max-height: 300px; border-radius: 50%; border: 8px solid #222; font-size: 2rem; font-weight: bold; color: #888; background: #d32f2f; box-shadow: inset 0 0 20px #000; pointer-events: none; margin-top: 20px; display: flex; align-items: center; justify-content: center; }
        .unlocked { background: radial-gradient(circle, #00e676, #00c853) !important; color: white !important; border-color: #00c853 !important; box-shadow: 0 0 40px rgba(0, 230, 118, 0.4) !important; pointer-events: auto !important; cursor: pointer; }
        .buzzed { background: #555 !important; color: #aaa !important; border-color: #777 !important; box-shadow: none !important; }
        .locked { background: #d32f2f !important; color: #ffcccc !important; border-color: #b71c1c !important; }
        .hidden { display: none !important; } .flex { display: flex !important; }
    </style>
</head>
<body>

    <div id="screen-room" class="setup-screen">
        <h1>Jeopardy Buzzer</h1>
        <input type="text" id="roomCode" placeholder="Raum Code" style="text-transform: uppercase; text-align:center;">
        <input type="password" id="mqttPass" placeholder="Passwort" style="text-align:center;">
        <button onclick="connectAndFetchPlayers()">Beitreten</button>
        <div id="conn-status" style="color: #888; margin-top: 10px;"></div>
    </div>

    <div id="screen-name" class="setup-screen hidden">
        <button onclick="location.reload()" style="background:#444; width:auto; margin-bottom:10px;">Zurück</button>
        <div id="nameList" style="width:100%; max-height:60vh; overflow-y:auto;"></div>
    </div>

    <div id="screen-game" class="hidden" style="flex-direction: column; align-items: center; width: 100%;">
        <h2 id="playerNameDisplay" style="font-size: 2rem;">Spieler</h2>
        <button id="buzzer-btn" onclick="buzz()">GESPERRT</button>
        <div id="status" style="margin-top: 30px; font-size: 1.4rem; color: #888; font-weight: bold;">Warte...</div>
        <button onclick="leaveGame()" style="background:#444; margin-top:40px; width:auto; padding: 10px 20px;">Abmelden</button>
    </div>

    <script>
        const BROKER = "wss://8a4b97051b294cff830f708512f57d7c.s1.eu.hivemq.cloud:8884/mqtt";
        const MQTT_USER = "jeopardy_user"; 
        
        let client;
        let roomId;
        let playerNum;
        let isPlaying = false;
        let lastPingTime = 0;

        // Leertaste Support
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space' && !document.getElementById("screen-game").classList.contains("hidden")) {
                e.preventDefault();
                const btn = document.getElementById("buzzer-btn");
                if (btn.classList.contains("unlocked")) buzz();
            }
        });

        window.addEventListener('pagehide', () => {
            if (isPlaying && client?.connected) client.publish(`jeopardy/${roomId}/leave`, playerNum.toString());
        });

        function leaveGame() {
            if (confirm("Abmelden?")) {
                if (client?.connected) client.publish(`jeopardy/${roomId}/leave`, playerNum.toString());
                location.reload();
            }
        }

        function connectAndFetchPlayers() {
            roomId = document.getElementById("roomCode").value.trim().toUpperCase();
            const pass = document.getElementById("mqttPass").value.trim();
            if(!roomId || !pass) return;
            
            document.getElementById("conn-status").innerText = "Verbinde...";
            const clientId = "jeo_" + Math.random().toString(16).substr(2, 8);
            
            try {
                client = mqtt.connect(BROKER, { clientId, username: MQTT_USER, password: pass, connectTimeout: 5000 });
            } catch(e) { return; }
            
            client.on("connect", () => {
                client.subscribe(`jeopardy/${roomId}/#`);
                client.publish(`jeopardy/${roomId}/players_request`, "get");
                startPingLoop();
            });

            client.on("message", (topic, message) => {
                if (topic.endsWith("players_response") && !isPlaying) {
                    try { showNameSelection(JSON.parse(message.toString())); } catch(e){}
                }
                if (topic.endsWith("status_json")) {
                     if(isPlaying) updateBuzzerStateJSON(JSON.parse(message.toString()));
                }
                if (topic.endsWith("status") && message.toString() === "game_over") {
                    alert("Spiel beendet"); location.reload();
                }
                // PONG Handling
                if (topic.endsWith("pong")) {
                    // Simple RTT calc
                    const rtt = Date.now() - lastPingTime;
                    // Store for next ping
                    window.lastRTT = rtt;
                }
            });
        }
        
        function startPingLoop() {
            setInterval(() => {
                if(client?.connected && isPlaying) {
                    lastPingTime = Date.now();
                    const payload = JSON.stringify({
                        type: "ping",
                        playerIdx: playerNum - 1,
                        ts: lastPingTime,
                        last_rtt: window.lastRTT || 0
                    });
                    client.publish(`jeopardy/${roomId}/ping`, payload);
                }
            }, 2000);
        }

        function showNameSelection(players) {
            document.getElementById("screen-room").classList.add("hidden");
            document.getElementById("screen-name").classList.remove("hidden");
            document.getElementById("screen-name").classList.add("flex");
            const list = document.getElementById("nameList");
            list.innerHTML = "";
            
            players.filter(p => !p.taken).forEach((p) => {
                const btn = document.createElement("button");
                btn.className = "name-btn";
                btn.innerText = p.name;
                btn.onclick = () => joinGame(p.id, p.name); 
                list.appendChild(btn);
            });
        }

        function joinGame(idx, name) {
            playerNum = idx;
            isPlaying = true;
            document.getElementById("screen-name").classList.add("hidden");
            document.getElementById("screen-name").classList.remove("flex");
            document.getElementById("screen-game").classList.remove("hidden");
            document.getElementById("screen-game").classList.add("flex");
            document.getElementById("playerNameDisplay").innerText = name;
            client.publish(`jeopardy/${roomId}/join`, idx.toString());
            updateBuzzerStateJSON({state: "locked"});
        }
        
        function updateBuzzerStateJSON(data) {
            const btn = document.getElementById("buzzer-btn");
            const stat = document.getElementById("status");
            
            // Check if excluded
            if (data.state === "unlocked") {
                if (data.excluded === (playerNum - 1)) {
                     btn.className = "locked";
                     btn.innerText = "GESPERRT";
                     stat.innerText = "Du warst schon!";
                     stat.style.color = "red";
                } else {
                    btn.className = "unlocked";
                    btn.innerText = "BUZZER!";
                    stat.innerText = "JETZT DRÜCKEN!";
                    stat.style.color = "#00e676";
                    if(navigator.vibrate) navigator.vibrate(100);
                }
            } else {
                btn.className = "locked";
                btn.innerText = "GESPERRT";
                stat.innerText = "Warte...";
                stat.style.color = "#888";
            }
        }

        function buzz() {
            const btn = document.getElementById("buzzer-btn");
            const payload = JSON.stringify({ type: "buzz", playerIdx: playerNum - 1, ts: Date.now() });
            client.publish(`jeopardy/${roomId}/buzz`, payload);
            btn.className = "buzzed";
            btn.innerText = "GEBUZZERT!";
            document.getElementById("status").innerText = "Signal gesendet!";
            if(navigator.vibrate) navigator.vibrate([50,50,50]);
            setTimeout(() => { if(btn.innerText==="GEBUZZERT!") { btn.className="locked"; btn.innerText="GESPERRT"; } }, 1000);
        }
    </script>
</body>
</html>
